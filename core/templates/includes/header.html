{% load humanize %}
{% load trend %}

<!-- Header -->
<div class="header pb-8 pt-5 pt-md-6 bg-secondary">
    <div class="container-fluid">
        <div class="header-body">
        <!-- Card stats -->
        <div class="row">
            <div class="col-xl-3 col-lg-6">
            <div class="card shadow card-stats mb-4 mb-xl-0 fade-in-top">
                <div class="card-body ">
                <div class="row">
                    <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Confirmed</h5>
                    <span id="daily_confirmed_label" class="h2 font-weight-bold mb-0">0</span>
                    </div>
                    <div class="col-auto">
                    <div class="icon icon-shape bg-primary text-white rounded-circle shadow">
                        <i class="fas fa-virus"></i>
                    </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                    <span id="trend_confirmed_label" class="mr-2">+0%</span>
                    <span class="text-nowrap">Since last week</span>
                </p>
                </div>
            </div>
            </div>
            <div class="col-xl-3 col-lg-6">
            <div class="card shadow card-stats mb-4 mb-xl-0 fade-in-top">
                <div class="card-body ">
                <div class="row">
                    <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Recovered</h5>
                    <span id="daily_recovered_label" class="h2 font-weight-bold mb-0">0</span>
                    </div>
                    <div class="col-auto">
                    <div class="icon icon-shape bg-green text-white rounded-circle shadow">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                    <span id="trend_recovered_label" class="mr-2">+0%</span>
                    <span class="text-nowrap">Since last week</span>
                </p>
                </div>
            </div>
            </div>
            <div class="col-xl-3 col-lg-6">
            <div class="card shadow card-stats mb-4 mb-xl-0 fade-in-top">
                <div class="card-body ">
                <div class="row">
                    <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Deaths</h5>
                    <span id="daily_deaths_label" class="h2 font-weight-bold mb-0">0</span>
                    </div>
                    <div class="col-auto">
                    <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                        <i class="fa fa-skull-crossbones"></i>
                    </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                    <span id="trend_deaths_label" class="mr-2">+0%</span>
                    <span class="text-nowrap">Since last week</span>
                </p>
                </div>
            </div>
            </div>
            <div class="col-xl-3 col-lg-6">
            <div class="card shadow card-stats mb-4 mb-xl-0 fade-in-top">
                <div class="card-body ">
                <div class="row">
                    <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Death Rate</h5>
                    <span id="daily_death_rate_label" class="h2 font-weight-bold mb-0">0</span>
                    </div>
                    <div class="col-auto">
                    <div class="icon icon-shape bg-warning text-white rounded-circle shadow">
                        <i class="fa fa-percent"></i>
                    </div>
                    </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                    <span id="trend_death_rate_label" class="mr-2">+0</span>
                    <span class="text-nowrap">Since last week</span>
                </p>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        window.addEventListener("load", function() {
            load_report();
            load_trends();
        });

        function load_report() {
            var xhttp_report = new XMLHttpRequest();

            xhttp_report.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.response);

                    document.getElementById("daily_confirmed_label").innerText = addCommas(data.num_confirmed);
                    document.getElementById("daily_recovered_label").innerText = addCommas(data.num_recovered);
                    document.getElementById("daily_deaths_label").innerText = addCommas(data.num_deaths);
                    document.getElementById("daily_death_rate_label").innerText = data.death_rate;
                }
            };

            xhttp_report.open("GET", "report");
            xhttp_report.send();
        }

        function load_trends() {
            var xhttp_trends = new XMLHttpRequest();

            xhttp_trends.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.response);

                    trend_confirmed_label = document.getElementById("trend_confirmed_label");
                    trend_recovered_label =  document.getElementById("trend_recovered_label");
                    trend_deaths_label = document.getElementById("trend_deaths_label");
                    trend_death_rate_label = document.getElementById("trend_death_rate_label");

                    if (data.confirmed_trend > 0) {
                        trend_confirmed_label.innerHTML = "<i class='fa fa-angle-up'></i>";
                        trend_confirmed_label.classList.add("text-danger");
                    }
                    else {
                        trend_confirmed_label.innerHTML = "<i class='fa fa-angle-down'></i>";
                        trend_confirmed_label.classList.add("text-success");
                    }

                    if (data.recovered_trend > 0) {
                        trend_recovered_label.innerHTML = "<i class='fa fa-angle-up'></i>";
                        trend_recovered_label.classList.add("text-success");
                    }
                    else {
                        trend_recovered_label.innerHTML = "<i class='fa fa-angle-down'></i>",
                        trend_recovered_label.classList.add("text-danger");
                    }

                    if (data.deaths_trend > 0) {
                        trend_deaths_label.innerHTML = "<i class='fa fa-angle-up'></i>";
                        trend_deaths_label.classList.add("text-danger");
                    }
                    else {
                        trend_deaths_label.innerHTML = "<i class='fa fa-angle-down'></i>";
                        trend_deaths_label.classList.add("text-success");
                    }

                    if (data.death_rate_trend > 0) {
                        trend_death_rate_label.innerHTML = "<i class='fa fa-angle-up'></i>";
                        trend_death_rate_label.classList.add("text-danger");
                    }
                    else {
                        trend_death_rate_label.innerHTML = "<i class='fa fa-angle-down'></i>";
                        trend_death_rate_label.classList.add("text-success");
                    }

                    trend_confirmed_label.innerHTML += " " + data.confirmed_trend + "%";
                    trend_recovered_label.innerHTML += " " + data.recovered_trend + "%";
                    trend_deaths_label.innerHTML += " " + data.deaths_trend + "%";
                    trend_death_rate_label.innerHTML += " " + data.death_rate_trend;
                }
            };

            xhttp_trends.open("GET", "trends");
            xhttp_trends.send();
        }

        function addCommas(input) {
            var number_string = input.toString();
            var result = "";

            for (let i = 0; i < number_string.length; i++) {
                result = number_string[number_string.length -1 - i] + result;

                if ((i + 1) % 3 == 0 && i != number_string.length - 1) {
                    result = "," + result;
                } 
            }

            return result;
        }
    </script>

</div>
